---
title: "Fyw_traditional_procedure"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fyw_traditional_procedure}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, message=FALSE}
# Load require packages
library(Fyw)
library(lubridate)
# devtools::install("path/to/package/folder")
```

### 1. Overview
This document describes how the young water fraction is calculated based on the 
traditional procedure (Kirchner, 2016). 

First we need data for this demonstration. Let's take the isotope data from the Alp catchment.

```{r, message=FALSE}
# Get isotope in precipitation (P) and streamflow (S) from the the Alp catchment
isotopeP <- subset(isotopeData, catchment == "Alp" & variable == "precipitation")
isotopeS <- subset(isotopeData, catchment == "Alp" &  variable == "streamflow")
```

### 2. Fyw estimation using the traditional procedure
In the traditionla procedure (Kirchner, 2016), Fyw is estimated using the following steps:

-   Step 1: Fit the sine wave to observed isotope in precipitation and streamflow 
using the Iteratively Least Squares (IRLS) regression approach. The fitted sine 
wave has the following form:

$$ c_P = a_P \cdot cos(2 \pi t) + b_P \cdot sin(2 \pi t) + k_P $$

```{r, message=FALSE}
#------------------------------------------------------------------------------#
#             Fit sine wave to observed isotope in precipitation               #
#------------------------------------------------------------------------------#
# First, convert date to decimal, ranging from [0, 1]
t <- decimal_date(isotopeP$date) - trunc(decimal_date(isotopeP$date))
  
# Fit to sine wave to observed isotope in P using IRLS method
sineP <- IRLS(Y = isotopeP$delta_18O,
              X = data.frame(cos = cos(2*pi*t), sin = sin(2*pi*t)),
              pweights = isotopeP$water_flux_mm)

#------------------------------------------------------------------------------#
#             Fit sine wave to observed isotope in streamflow                  #
#------------------------------------------------------------------------------#
# First, convert date to decimal, ranging from [0, 1]
t <- decimal_date(isotopeS$date) - trunc(decimal_date(isotopeS$date))
  
# Fit to sine wave to observed isotope in P using IRLS method
sineS <- IRLS(Y = isotopeS$delta_18O,
              X = data.frame(cos = cos(2*pi*t), sin = sin(2*pi*t)),
              pweights = isotopeS$water_flux_mm)

```

-   Step 2: Find Fyw from the two fitted sine waves
```{r, message=FALSE}
# Parameters of the fitted sine wave to isotope in precipitation
kP <- as.numeric(sineP$coefficients[1])
aP <- as.numeric(sineP$coefficients[2])
bP <- as.numeric(sineP$coefficients[3])

# Parameters of the fitted sine wave to isotope in precipitation
kS <- as.numeric(sineS$coefficients[1])
aS <- as.numeric(sineS$coefficients[2])
bS <- as.numeric(sineS$coefficients[3])

# Amplitudes of the fitted sine wave to precipitation and streamflow
AP <- sqrt(aP^2 + bP^2)
AS <- sqrt(aS^2 + bS^2)

# Phase 
phiP <- findPhi(aP = aP, bP = bP)
phiS <- findPhi(aP = aS, bP = bS)

# Phase shift
phiS_phiP <- phiS - phiP

# Parameters of the gamma (transit time distribution)
alphaBetaMTT <- findAlphaBetaMTT(phiS_phiP = phiS_phiP,
                                 AS = AS,
                                 AP = AP)

# Age threshold of the young water fraction
tauyw <- findtauyw(alpha = alphaBetaMTT$alpha, method = "approximation")$tauyw

# Young water fraction (equals to the amplitude ratio)
Fyw_1 <- AS/AP

# Or the young water fraction equal
Fyw_2 <- pgamma(q = tauyw, 
                      shape = alphaBetaMTT$alpha,
                      scale = alphaBetaMTT$beta,
                      lower.tail = TRUE)

# Show the results in data frame
t(data.frame(AP = AP, phiP = phiP, kP = kP, AS = AS, phiS = phiS, kS = kS, 
             Fyw_1 = Fyw_1, Fyw_2 = Fyw_2, tauyw = tauyw))
```





